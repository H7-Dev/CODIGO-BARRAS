<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerador de Etiquetas - Almoxarifado</title>
    <!-- Adicionando biblioteca JsBarcode para gera√ß√£o local -->
    <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
    
    <!-- Estilo Din√¢mico para Impress√£o (Ser√° atualizado via JS) -->
    <style id="dynamic-print-style">
        @media print {
            @page {
                size: A4;
                margin: 10mm;
            }
        }
    </style>

    <style>
        /* --- RESET E BASE --- */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: Arial, Helvetica, sans-serif;
        }

        body {
            background-color: #e2e8f0; /* Fundo mais escuro para destacar a folha */
            display: flex;
            height: 100vh;
            overflow: hidden;
        }

        /* --- PAINEL LATERAL (CONTROLES) --- */
        .sidebar {
            width: 360px;
            background: white;
            border-right: 1px solid #cbd5e1;
            display: flex;
            flex-direction: column;
            padding: 20px;
            overflow-y: auto;
            box-shadow: 4px 0 15px rgba(0,0,0,0.05);
            z-index: 20;
        }

        h2 {
            color: #1e293b;
            font-size: 1.25rem;
            margin-bottom: 20px;
            border-bottom: 1px solid #f1f5f9;
            padding-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .tabs {
            display: flex;
            background: #f1f5f9;
            padding: 4px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .tab-btn {
            flex: 1;
            padding: 8px;
            border: none;
            background: none;
            cursor: pointer;
            font-size: 12px;
            font-weight: bold;
            text-transform: uppercase;
            border-radius: 6px;
            color: #94a3b8;
            transition: all 0.2s;
        }

        .tab-btn.active {
            background: white;
            color: #dc2626; /* Red-600 */
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .tab-btn.active.bulk {
            color: #16a34a; /* Green-600 */
        }

        .form-group {
            margin-bottom: 15px;
            background: #f8fafc;
            padding: 12px;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
        }

        .input-wrapper {
            margin-bottom: 10px;
        }

        .input-label {
            display: block;
            font-size: 11px;
            color: #64748b;
            margin-bottom: 2px;
            font-weight: bold;
        }

        input[type="text"], input[type="number"], textarea, select {
            width: 100%;
            padding: 8px;
            border: 1px solid #cbd5e1;
            border-radius: 4px;
            font-size: 14px;
            outline: none;
            transition: border-color 0.2s;
            background: white;
        }

        input[type="text"]:focus, input[type="number"]:focus, textarea:focus, select:focus {
            border-color: #dc2626;
            background: #fef2f2;
        }

        textarea {
            height: 150px;
            font-family: monospace;
            resize: none;
            white-space: pre;
        }

        .action-btn {
            width: 100%;
            padding: 10px;
            margin-bottom: 10px;
            border: none;
            border-radius: 6px;
            font-weight: bold;
            cursor: pointer;
            font-size: 13px;
        }

        .btn-add {
            background-color: #2563eb;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
        }
        .btn-add:hover { background-color: #1d4ed8; }

        .btn-clear {
            background-color: white;
            border: 1px solid #ef4444;
            color: #ef4444;
        }
        .btn-clear:hover { background-color: #fef2f2; }

        .print-btn {
            margin-top: auto;
            width: 100%;
            padding: 16px;
            background: linear-gradient(to right, #dc2626, #ef4444);
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: bold;
            font-size: 16px;
            cursor: pointer;
            box-shadow: 0 4px 6px rgba(220, 38, 38, 0.2);
            transition: transform 0.1s;
        }
        .print-btn:hover {
            filter: brightness(1.1);
        }

        /* --- √ÅREA DE VISUALIZA√á√ÉO (PREVIEW) --- */
        .preview-area {
            flex: 1;
            padding: 20px 40px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
        }

        /* --- SIMULA√á√ÉO DA FOLHA DE PAPEL --- */
        .paper-sheet {
            background: white;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            margin: 20px auto;
            /* Padding visual que simula a margem de impress√£o */
            padding: 10mm; 
            /* Dimens√µes A4 padr√£o */
            width: 210mm; 
            min-height: 297mm;
            
            display: flex;
            flex-direction: column;
            align-items: center; /* Centraliza as etiquetas na folha */
            gap: 2mm; /* Espa√ßamento entre etiquetas */
            box-sizing: border-box;
            
            position: relative;
            transition: all 0.3s ease;
        }

        /* R√≥tulo da folha */
        .paper-label {
            position: absolute;
            top: -25px;
            left: 0;
            background: #94a3b8;
            color: white;
            font-size: 11px;
            padding: 4px 8px;
            border-radius: 4px;
            font-weight: bold;
            text-transform: uppercase;
        }

        /* --- PREVIEW FLUTUANTE DO RASCUNHO --- */
        .draft-preview-container {
            width: 100%;
            max-width: 210mm;
            margin-bottom: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            opacity: 1;
            transition: opacity 0.3s;
        }
        
        .draft-preview-container.faded {
            opacity: 0.5; /* Fica transparente quando n√£o est√° na folha */
        }

        .draft-label-title {
            font-size: 11px;
            font-weight: bold;
            color: #64748b;
            margin-bottom: 8px;
            text-transform: uppercase;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        /* --- O DESIGN DA ETIQUETA --- */
        .label-container {
            background: white;
            position: relative;
            box-shadow: 0 0 0 1px rgba(0,0,0,0.1); /* Borda sutil para ver limites brancos */
            flex-shrink: 0;
            page-break-inside: avoid;
        }

        .cut-line {
            position: absolute;
            inset: 0;
            border: 1px dashed #cbd5e1;
            pointer-events: none;
            z-index: 5;
        }

        .label-grid {
            position: absolute;
            top: 4px; left: 4px; right: 4px; bottom: 4px;
            border: 2px solid black;
            display: flex;
            flex-direction: column;
            background: white;
            z-index: 1;
        }

        /* Estilos Internos da Etiqueta */
        .label-header { height: 18%; display: flex; border-bottom: 1px solid black; }
        .header-left { width: 40%; background-color: #DC2626; color: white; border-right: 1px solid black; display: flex; align-items: center; justify-content: center; font-size: 07px; font-weight: bold; text-transform: uppercase; text-align: center; line-height: 1.1; padding: 0 2px;}
        .header-right { width: 60%; background-color: #DC2626; color: white; display: flex; align-items: center; justify-content: center; font-size: 10px; font-weight: bold; text-transform: uppercase; letter-spacing: 0.5px; }
        
        /* Modo Preto e Branco */
        .label-grid.bw .header-left, .label-grid.bw .header-right {font-size :08px; background-color: black !important; color: white !important; }

        .label-body { flex: 1; display: flex; border-bottom: 1px solid black; }
        .body-left { width: 40%; border-right: 1px solid black; display: flex; align-items: center; justify-content: center; padding: 5px; }
        .body-left img { max-width: 100%; max-height: 100%; object-fit: contain; }
        .body-right { width: 60%; display: flex; align-items: center; justify-content: center; padding: 2px 16px; overflow: hidden; }
        .barcode-svg { width: 100%; height: 100%; display: block; }

        .label-footer { height: 25%; display: flex; }
        .footer-left { width: 40%; border-right: 1px solid black; display: flex; align-items: center; justify-content: center; }
        .footer-left span { font-size: 12px; font-weight: bold; text-transform: uppercase; color: black; text-align: center;}
        .footer-right { width: 60%; display: flex; align-items: center; justify-content: center; padding: 0 4px; }
        .footer-right span { font-size: 24px; font-weight: bold; color: black; line-height: 1; }

        .counter {
            position: absolute;
            left: -30px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 10px;
            color: #94a3b8;
            font-weight: bold;
        }

        /* --- CONFIGURA√á√ïES DE IMPRESS√ÉO --- */
        @media print {
            * {
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }
            body { 
                background: white; 
                display: block; 
                height: auto; 
                overflow: visible;
            }
            .sidebar, .draft-preview-container, .paper-label { display: none !important; }
            .preview-area { 
                padding: 0; 
                display: block;
                overflow: visible;
            }
            .paper-sheet {
                box-shadow: none;
                margin: 0;
                width: auto;
                min-height: auto;
                padding: 0; /* A margem √© controlada pelo @page */
                background: none;
            }
            
            .label-container {
                box-shadow: none;
                /* Espa√ßamento para corte manual */
                margin-bottom: 5px; 
            }
            
            body.print-cuts .cut-line { display: block !important; border-color: black; }
            body:not(.print-cuts) .cut-line { display: none !important; }
            .counter { display: none; }
        }
        
        .hidden { display: none; }
    </style>
</head>
<body>

    <!-- PAINEL DE CONTROLE -->
    <div class="sidebar">
        <h2>üè∑Ô∏è Gerador Pro</h2>

        <div class="tabs">
            <button class="tab-btn active" id="btnSingle" onclick="setMode('single')">Editor Manual</button>
            <button class="tab-btn" id="btnBulk" onclick="setMode('bulk')">Importar Excel</button>
        </div>
        
        <!-- Configura√ß√µes Gerais -->
        <div style="background: #f1f5f9; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
            <div style="font-size: 10px; font-weight: bold; color: #64748b; text-transform: uppercase; margin-bottom: 10px;">Configura√ß√£o da P√°gina</div>
            
            <div class="input-wrapper">
                <span class="input-label">Layout da P√°gina</span>
                <select id="paperType" onchange="render()" style="font-weight:bold; color:#1e293b;">
                    <option value="a4">Folha A4 (Lista Vertical)</option>
                    <option value="thermal">Rolo T√©rmico (1 por p√°g)</option>
                </select>
            </div>
            
            <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                <div style="flex:1">
                    <span class="input-label">Largura (mm)</span>
                    <input type="number" id="labelWidth" value="70" oninput="render()">
                </div>
                <div style="flex:1">
                    <span class="input-label">Altura (mm)</span>
                    <input type="number" id="labelHeight" value="30" oninput="render()">
                </div>
            </div>

            <div style="display: flex; flex-direction: column; gap: 8px;">
                <label style="display: flex; align-items: center; gap: 8px; font-size: 12px; cursor: pointer; color: #333;">
                    <input type="checkbox" id="bwMode" onchange="render()">
                    <span>Preto e Branco</span>
                </label>
                <label style="display: flex; align-items: center; gap: 8px; font-size: 12px; cursor: pointer; color: #333;">
                    <input type="checkbox" id="printCuts" checked onchange="render()">
                    <span>Linha de Corte (Tracejada)</span>
                </label>
            </div>
        </div>

        <!-- MODO MANUAL -->
        <div id="singleMode">
            <div style="background: white; border: 2px solid #3b82f6; padding: 15px; border-radius: 8px; margin-bottom: 15px; position: relative;">
                <div style="position: absolute; top: -10px; left: 10px; background: #3b82f6; color: white; font-size: 10px; padding: 2px 8px; border-radius: 4px; font-weight: bold;">NOVA ETIQUETA</div>
                
                <div style="margin-top: 10px;">
                    <div class="input-wrapper">
                        <span class="input-label">Local (Cabe√ßalho Esq.)</span>
                        <input type="text" id="warehouse" value="ALMOXARIFADO" oninput="render()">
                    </div>
                    <div class="input-wrapper">
                        <span class="input-label">T√≠tulo (Cabe√ßalho Dir.)</span>
                        <input type="text" id="headerRight" value="C√ìDIGO" oninput="render()">
                    </div>
                     <div class="input-wrapper">
                        <span class="input-label" style="color:#2563eb">VALOR DO C√ìDIGO (Barras)</span>
                        <input type="text" id="code" value="001.2024" style="font-weight: bold; font-family: monospace; border-color: #3b82f6;" oninput="render()">
                    </div>
                    <div class="input-wrapper">
                        <span class="input-label">R√≥tulo Rodap√©</span>
                        <input type="text" id="addressLabel" value="ENDERE√áO" oninput="render()">
                    </div>
                     <div class="input-wrapper">
                        <span class="input-label">Logo URL (Opcional)</span>
                        <input type="text" id="logoUrl" value="./image.png" placeholder="http://..." oninput="render()">
                    </div>
                </div>

                <button class="action-btn btn-add" onclick="addToQueue()">
                    <span>‚¨á Adicionar √† Folha</span>
                </button>
            </div>

            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; padding: 0 5px;">
                <span style="font-size: 12px; font-weight: bold; color: #475569;">Na Folha: <span id="queueCount" style="color: #2563eb;">0</span> itens</span>
                <button class="btn-clear" style="padding: 4px 10px; font-size: 10px; width: auto; border-radius: 20px;" onclick="clearQueue()">Limpar Folha</button>
            </div>
        </div>

        <!-- MODO EXCEL -->
        <div id="bulkMode" class="hidden">
            <div class="form-group" style="background: #ecfdf5; border-color: #6ee7b7;">
                <label style="color: #047857;">Importar Dados</label>
                <p style="font-size: 11px; color: #065f46; margin-bottom: 5px;">
                    Copie do Excel e cole abaixo (sem cabe√ßalho).
                </p>
                <div style="background: white; padding: 5px; border: 1px dashed #10b981; border-radius: 4px; font-size: 9px; font-family: monospace; white-space: nowrap; overflow-x: auto; color: #059669;">
                    Local | T√≠tulo | R√≥tulo | Valor | Logo
                </div>
            </div>
            <textarea id="bulkInput" placeholder="Ex:&#10;DEP√ìSITO	C√ìD.	ENDERE√áO	A-01	&#10;DEP√ìSITO	C√ìD.	ENDERE√áO	A-02" oninput="parseBulk()"></textarea>
            <div style="display: flex; justify-content: space-between; margin-top: 10px; font-size: 12px;">
                <span id="countDisplay">0 etiquetas</span>
                <button onclick="clearBulk()" style="color: #ef4444; background: none; border: none; cursor: pointer;">Limpar</button>
            </div>
        </div>

        <button class="print-btn" onclick="window.print()">IMPRIMIR FOLHA</button>
    </div>

    <!-- √ÅREA DE PREVIEW -->
    <div class="preview-area" id="previewArea">
        
        <!-- Rascunho Flutuante -->
        <div id="draftContainer" class="draft-preview-container">
            <div class="draft-label-title">
                <span style="display:inline-block; width:8px; height:8px; background:#3b82f6; border-radius:50%;"></span>
                Rascunho (Editando...)
            </div>
            <!-- O Preview do Rascunho ser√° injetado aqui -->
            <div id="draftTarget"></div>
        </div>

        <!-- Folha de Papel -->
        <div class="paper-sheet" id="paperSheet">
            <div class="paper-label">Folha de Impress√£o (A4)</div>
            <!-- As etiquetas confirmadas ser√£o injetadas aqui -->
            <div id="sheetTarget" style="width: 100%; display: flex; flex-direction: column; align-items: center; gap: 5px;">
                <div style="color: #cbd5e1; margin-top: 100px; text-align: center; font-size: 14px;">
                    A folha est√° vazia.<br>Use o editor acima e clique em "Adicionar".
                </div>
            </div>
        </div>

    </div>

    <script>
        // ESTADO GLOBAL
        let currentMode = 'single';
        let queueData = []; // Fila Manual
        let bulkData = [];  // Dados do Excel

        // Inicializa√ß√£o
        document.addEventListener('DOMContentLoaded', () => {
            render();
        });

        function setMode(mode) {
            currentMode = mode;
            document.getElementById('singleMode').classList.toggle('hidden', mode !== 'single');
            document.getElementById('bulkMode').classList.toggle('hidden', mode !== 'bulk');
            
            document.getElementById('btnSingle').className = `tab-btn ${mode === 'single' ? 'active' : ''}`;
            document.getElementById('btnBulk').className = `tab-btn bulk ${mode === 'bulk' ? 'active' : ''}`;
            
            // Limpa visualiza√ß√£o ao trocar de modo para evitar confus√£o
            render();
        }

        function addToQueue() {
            const newItem = {
                warehouse: document.getElementById('warehouse').value,
                headerRight: document.getElementById('headerRight').value,
                logo: document.getElementById('logoUrl').value,
                code: document.getElementById('code').value,
                addressLabel: document.getElementById('addressLabel').value
            };
            
            queueData.push(newItem);
            render();
            
            // Feedback no bot√£o
            const btn = document.querySelector('.btn-add');
            const originalHTML = btn.innerHTML;
            btn.innerHTML = "<span>‚úì Adicionado!</span>";
            btn.style.backgroundColor = "#10b981";
            setTimeout(() => {
                btn.innerHTML = originalHTML;
                btn.style.backgroundColor = "";
            }, 800);
        }

        function clearQueue() {
            if(queueData.length > 0 && confirm('Limpar a folha de impress√£o?')) {
                queueData = [];
                render();
            }
        }

        function updatePrintSettings(width, height, printCuts, paperType) {
            const styleEl = document.getElementById('dynamic-print-style');
            
            let printCSS = '';
            
            if (paperType === 'a4') {
                printCSS = `
                    @media print {
                        @page { size: A4; margin: 10mm; }
                        .paper-sheet { width: auto; min-height: auto; padding: 0; margin: 0; }
                        .label-container { 
                            width: ${width}mm !important; 
                            height: ${height}mm !important; 
                            margin-bottom: 2mm; 
                            page-break-inside: avoid;
                        }
                    }
                `;
            } else {
                printCSS = `
                    @media print {
                        @page { size: ${width}mm ${height}mm; margin: 0; }
                        .paper-sheet { width: auto; padding: 0; margin: 0; }
                        .label-container { 
                            width: ${width}mm !important; 
                            height: ${height}mm !important; 
                            page-break-after: always; 
                        }
                    }
                `;
            }
            
            styleEl.innerHTML = printCSS;
            
            if (printCuts) document.body.classList.add('print-cuts');
            else document.body.classList.remove('print-cuts');
        }

        function render() {
            // Configura√ß√µes
            const width = document.getElementById('labelWidth').value || 100;
            const height = document.getElementById('labelHeight').value || 70;
            const isBW = document.getElementById('bwMode').checked;
            const printCuts = document.getElementById('printCuts').checked;
            const paperType = document.getElementById('paperType').value;

            updatePrintSettings(width, height, printCuts, paperType);

            // 1. Renderiza o RASCUNHO (Sempre vis√≠vel no modo manual)
            const draftTarget = document.getElementById('draftTarget');
            const draftContainer = document.getElementById('draftContainer');
            
            if (currentMode === 'single') {
                draftContainer.style.display = 'flex';
                
                const draftItem = {
                    warehouse: document.getElementById('warehouse').value,
                    headerRight: document.getElementById('headerRight').value,
                    logo: document.getElementById('logoUrl').value,
                    code: document.getElementById('code').value,
                    addressLabel: document.getElementById('addressLabel').value
                };
                
                draftTarget.innerHTML = createLabelHTML(draftItem, 'Novo', true, width, height, isBW);
                
                // Se a folha tem itens, o rascunho fica transparente/desabilitado visualmente para indicar que n√£o ser√° impresso ainda
                // Mas mantemos vis√≠vel para edi√ß√£o
                if (queueData.length > 0) {
                    // draftContainer.classList.add('faded'); // Opcional: estilo visual
                } else {
                    // draftContainer.classList.remove('faded');
                }
            } else {
                draftContainer.style.display = 'none';
            }

            // 2. Renderiza a FOLHA (Queue ou Bulk)
            const sheetTarget = document.getElementById('sheetTarget');
            const paperSheet = document.getElementById('paperSheet');
            
            // Dados para a folha
            let dataForSheet = (currentMode === 'single') ? queueData : bulkData;
            
            sheetTarget.innerHTML = '';
            
            if (dataForSheet.length === 0) {
                // Se n√£o tem nada na fila
                if (currentMode === 'single') {
                    // No modo manual, se a fila ta vazia, mostra mensagem
                    sheetTarget.innerHTML = `
                        <div style="color: #94a3b8; margin-top: 80px; text-align: center; font-size: 13px; font-style: italic;">
                            Configure a etiqueta acima e clique em<br><strong>"Adicionar √† Folha"</strong>
                        </div>`;
                } else {
                    sheetTarget.innerHTML = `
                        <div style="color: #94a3b8; margin-top: 80px; text-align: center; font-size: 13px;">
                            Cole os dados do Excel para gerar a folha.
                        </div>`;
                }
            } else {
                dataForSheet.forEach((item, index) => {
                    const html = createLabelHTML(item, index + 1, true, width, height, isBW);
                    sheetTarget.insertAdjacentHTML('beforeend', html);
                });
            }

            // Atualiza contadores
            document.getElementById('queueCount').innerText = queueData.length;
            document.getElementById('countDisplay').innerText = bulkData.length + ' etiquetas';

            // Renderiza c√≥digos de barras
            try { JsBarcode(".barcode-svg").init(); } catch (e) {}
        }

        function parseBulk() {
            const text = document.getElementById('bulkInput').value;
            if (!text.trim()) {
                bulkData = [];
                render();
                return;
            }
            const lines = text.trim().split('\n');
            bulkData = lines.map(line => {
                const cols = line.split('\t');
                return {
                    warehouse: cols[0]?.trim() || '',
                    headerRight: cols[1]?.trim() || 'C√ìDIGO',
                    addressLabel: cols[2]?.trim() || 'ENDERE√áO',
                    code: cols[3]?.trim() || '',
                    logo: cols[4]?.trim() || './image.png'
                };
            }).filter(item => item.code);
            render();
        }

        function clearBulk() {
            document.getElementById('bulkInput').value = '';
            parseBulk();
        }

        function createLabelHTML(data, index, showBorder, width, height, isBW) {
            const barcodeValue = data.code.replace(/[^0-9a-zA-Z]/g, '');
            const bwClass = isBW ? 'bw' : '';
            
            let logoHTML = '<div style="width:100%; height:100%;"></div>';
            if (data.logo) {
                logoHTML = `<img src="${data.logo}" alt="Logo" onerror="this.style.display='none'">`;
            }

            // Se index for string (ex: 'Novo'), n√£o mostra n√∫mero
            const counterHTML = typeof index === 'number' ? `<div class="counter">${index}</div>` : '';

            return `
            <div class="label-container" style="width: ${width}mm; height: ${height}mm;">
                <div class="cut-line"></div>
                ${counterHTML}
                <div class="label-grid ${bwClass}">
                    <div class="label-header">
                        <div class="header-left">${data.warehouse}</div>
                        <div class="header-right">${data.headerRight}</div>
                    </div>
                    <div class="label-body">
                        <div class="body-left">${logoHTML}</div>
                        <div class="body-right">
                            <svg class="barcode-svg"
                                jsbarcode-format="CODE128"
                                jsbarcode-value="${barcodeValue}"
                                jsbarcode-displayValue="false"
                                jsbarcode-width="2"
                                jsbarcode-height="50"
                                jsbarcode-margin="0">
                            </svg>
                        </div>
                    </div>
                    <div class="label-footer">
                        <div class="footer-left"><span>${data.addressLabel}</span></div>
                        <div class="footer-right"><span>${data.code}</span></div>
                    </div>
                </div>
            </div>
            `;
        }
    </script>
</body>
</html>